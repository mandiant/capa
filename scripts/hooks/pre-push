
# Use a console with emojis support for a better experience

# Stash uncommited changes
MSG="pre-push-$(date +%s)"
git stash push -kqum $MSG
STASH_LIST=$(git stash list)
if [[ "$STASH_LIST" == *"$MSG"* ]]; then
  echo "Uncommited changes stashed with message '$MSG', if you abort before they are restored run \`git stash pop\`"
fi

restore_stashed() {
  if [[ "$STASH_LIST" == *"$MSG"* ]]; then
    git stash pop -q --index
    echo "Stashed changes '$MSG' restored"
  fi
}

# Run style checker and print state
pycodestyle --config=./ci/tox.ini ./capa/ > style-checker-output.log 2>&1
if [ $? == 0 ]; then
  echo 'Style checker succeeds!! ğŸ’˜'
else
  echo 'Style checker failed ğŸ˜­ PUSH ABORTED\nCheck style-checker-output.log for details'
  restore_stashed
  exit 1
fi

# Run rule linter and print state
python ./scripts/lint.py ./rules/ > rule-linter-output.log 2>&1
if [ $? == 0 ]; then
  echo 'Rule linter succeeds!! ğŸ’–'
else
  echo 'Rule linter failed ğŸ˜­ PUSH ABORTED\nCheck rule-linter-output.log for details'
  restore_stashed
  exit 2
fi

# Run tests
echo 'Running tests, please wait âŒ›'
pytest tests/ --maxfail=1
if [ $? == 0 ]; then
  echo 'Tests succeed!! ğŸ‰'
else
  echo 'Tests failed ğŸ˜“ PUSH ABORTED\nRun `pytest -v --cov=capa test/` if you need more details'
  restore_stashed
  exit 3
fi

echo 'PUSH SUCCEEDED ğŸ‰ğŸ‰'

restore_stashed
